%toc%

<article>

# npm & package.json

![banner image displaying conveyor belts moving lots of packages](../../../../public/assets/images/app/web_development/posts/npm/banner.png)

## npm

**npm** (Node Package Manager) is a package manager, that comes with every installation of Node.js but can be installed / updated seperatly if needed. npm is Command Line Interface (CLI) tool that is used to install the dependencies listed in a package.json file. By default it will install packages that are hosted on npmjs.com but it can also be used to install the content of a GitHub repository (or any other git online platform like for example [GitLab](https://about.gitlab.com/)). There are several popular alternatives to npm, like [yarn](https://yarnpkg.com/) or [PNPm](https://pnpm.io/)

> [!MORE]  
> [npm documentation](https://docs.npmjs.com/)  

### Installation

You usually don't need to install NPM manually as it is bundled with Node.js, so if you installed Node.js you already have npm installed too

### checking the current NPM version

you can use the following command in the VSCode terminal (or your favorite command line tool), to check which version of NPM is currently installed:

```shell
npm -v
```

### Updating

To update npm manually to the latest version, open the VSCode terminal (or use your favorite command line tool) and enter the following command:

```shell
npm install -g npm@latest
```

## package.json

**package.json** is a file that you will find in most Javascript (Typescript) projects. Package.json is a JSON file that contains metadata about the project, like the project name, a description and the current version, a list of dependencies as well as devDependencies, scripts (custom scripts that can be run from the command line using `npm run SCRIPT_NAME`), ...

**package-lock.json** is a file that gets created when you install packages using a package manager. It lists the exact version of each installed package and its dependencies (unlike the package.json itself which often will allow for a range of different versions to be installed). This file is important as it can be used to create reproducible builds. When you test your project on the staging server and then deploy it to production you don't want the packages versions to be different, as this could introduce bugs after you are done testing if a package uses a newer version in production than previously on the staging server.

> [!MORE]  
> [npmjs.com "package.json" documentation](https://docs.npmjs.com/cli/configuring-npm/package-json)  
> [nodejs.org "Modules: Packages" documentation](https://nodejs.org/api/packages.html)  

### creating a package.json

You can obviously create one manually using your IDE or copy a package.json from another project and then edit it to fit your needs, but the easiest way is to use the npm cli and let it create a package.json for you

Use your VSCode terminal (or favorite command line tool) to execute the following command and have npm guide you step by step through the creation of your `package.json` file:

```shell
npm init
```

Anser the questions that get displayed, when this is done npm will create a `package.json` in the root of your project

### dependencies

The part of your package.json that will change the most is probably the dependencies section

The dependencies list is an object that maps a dependency name to a version (for all dependencies that come from registry like npmjs.com)

### add a dependency

You can of course add a dependency manually by editing the package.json and then run the command `npm i` to install it

But usually you will use a command, for example to install react you would use:

```shell
npm i react react-dom
```

this will install react and react-dom and add update your package.json as well as package-locl.json files

```json title="package.json"
    "dependencies": {
        "react": "^18.2.0",
        "react-dom": "^18.2.0",
    },
```

#### what are dependecies semver versions?

packages use semantic versioning (semver) for their version numbers, with semver a version has 3 parts **MAJOR.MINOR.PATCH**:

* if the patch number changes it means there has been a fix that does NOT introduce any breaking changes and also NO new features but one or more existing features recieved a fix, meaning if you install that version nothing is supposed to break in your code
* the second number indicates a minor change has happend, meaning a new feature got added to the package but this new feature does not introduce breaking changes
* the major version indicates that existing features got modified in a way that potentially will introduce breaking changes, so when updating a package and there is a change in the major version it is highly recommended that you check out the changelog of the package and identify breaking change notes and also verify that your code that uses the package is not impacted by those breaking changes, if it is impacted then you need to update your code accordingly

> [!NOTE]  
> when you install a dependency, the verion will be prefixed with a **^** (carret), when using **caret ranges** npm will install the version you specified as long as there is no newer version available, if however a newer PATCH or even MINOR version is available then npm will install the newer version instead, if we take the example above where we have "^18.2.0", this means npm will install react 18.2.0 as long as there is no update, however if react releases a fix for an existing feature and increment their PATCH number then the newest version would be 18.2.1 and if you now use the npm install command then npm will install 18.2.1 (and not 18.2.0 anymore), this is also true if the react team adds a new feature and bumps their MINOR number to 18.3.0 then npm will install that version, however if the react team adds breaking changes and the new version is 19.0.0 then npm will not update your package because this version might introduce breaking changes, instead npm will use the latest 18.x.x version that is available

> [!MORE]  
> [Semantic Versioning Specification](https://semver.org/)  
> [npmjs-com "About semantic versioning" documentation](https://docs.npmjs.com/about-semantic-versioning)  

#### dependecy version pinning (optional)

if (like me) you prefer to **pinning** versions of package, then add the option **--save-exact** to your command:

```shell
npm i react react-dom --save-exact
```

this will add the dependencies to your package.json as before, but the difference is that the verion will NOT be prefixed with a **^** (carret):

```json title="package.json"
    "dependencies": {
        "react": "18.2.0",
        "react-dom": "18.2.0",
    },
```

> [!NOTE]  
> I like to pin versions so that I know exactly which version of each dependency is installed, from time to time I manually update all my dependencies, depending on how big the difference between two versions is I also visit the dependencies GitHub repository and check the change.log so that I'm aware of what has changed between the version I had installed and the new version I'm about to install, this helps find out about new features I might want to use and if I see that there is a section mentioning potential breacking changes then I know what I need to verify and eventually update in my code  

#### VSCode extension for manual version updates

To make manual updates of my dependencies easier, I use a VSCode extension called [versionlens](https://marketplace.visualstudio.com/items?itemName=pflannery.vscode-versionlens), I like this extension because when I open my package.json it will fetch all the versions of the packages I have installed and tell if a new version is available, if there is a new version and I want to use it all I need to do is click on **â†‘ latest x.x.x** (where x.x.x stands for the new version number) and version lens will insert the new version for me, when I'm done with updating the versions I save the package.json and then install the new versions with the command `npm i`

> [!MORE]  
> [VSCode "versionlens" extension](https://marketplace.visualstudio.com/items?itemName=pflannery.vscode-versionlens)  

### Git(Hub) URLs as Dependencies

If a package / repository has not been published on npm, for example one of your own projects on GitHub and you want to add it as a dependency to your project then you can do this too

```json title="package.json"
"dependencies": {
    "GITHUB_REPOSITORY_NAME": "github:USER_NAME/REPOSITORY_NAME",
},
```

this will add the package located at https://github.com/USER_NAME/REPOSITORY_NAME as a dependency

If you want to pin a more specific version of the repository you can do so by adding a hash symbol at the end followed by the commit id or follwed by the tag (if the author of the repository has published a tag) or a release version

Example of adding a repository with the latest commit id being **d29f7d9** then you would do like this:

```json title="package.json"
"dependencies": {
    "GITHUB_REPOSITORY_NAME": "github:USER_NAME/REPOSITORY_NAME#d29f7d9",
},
```

> [!MORE]  
> [npmjs.com "package.json git(hub) urls" documentation](https://docs.npmjs.com/cli/v10/configuring-npm/package-json#github-urls)  

#### private repositories as dependency

> [!NOTE]  
> It is also possible to use a Git(Hub) url of a private repository but you need to add a method that will grant access to that private repository so that the tools in your pipeline can access it, for example when fetching those dependencies to start development but also later when doing deployments, so be careful what you use to access the private repository as some methods might for example not be compatible with the deployment tools or the hosting platform you use  

I will list a few methods here and add some links to relevant documentation but I will not add complete walkthrough as those differ quite a lot depending on what platform your code is hosted and based on what tools are in your deployment pipeline (if however I see that there is interest in such a tutorial in the [GitHub discussions for chris.lu](https://github.com/chrisweb/chris.lu/discussions) then I might write one in the future)

An alternative to using private GitHub repositories is to use npm to host [private packages](https://docs.npmjs.com/creating-and-publishing-private-packages), but be aware that this is a paid service

##### using a GitHub personal access token

This method is for example recommended if you intend to deploy on Vercel, in their [Private dependencies on Vercel](https://vercel.com/guides/using-private-dependencies-with-vercel) documentation this is the method they recommend using, if this is the method you chose then might first check out the [GitHub personal access tokens](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens) documentation which explains how to create and manage personal access tokens

First you need to create a personal access token and then by adding the private repository to the `package.json` like this it will be possible to access the private repository using the personal access token:

```json title="package.json"
"dependencies": {
    "GITHUB_REPOSITORY_NAME": "git+https://USER_NAME:PERSONAL_TOKEN@github.com:USER_NAME/REPOSITORY_NAME"
}
```

> [!MORE]  
> [Vercel "How do I use private dependencies with Vercel?" documentation](https://vercel.com/guides/using-private-dependencies-with-vercel)  
> [GitHub "Managing your personal access tokens" documentation](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens)  

##### using a GitHub App access tokens

If you are part of an organisation on GitHub there is an alternative you might want to check out called [GitHub App installation access tokens](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys#github-app-installation-access-tokens)

> [!MORE]  
> [GitHub "App installation access tokens" documentation](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys#github-app-installation-access-tokens)  

##### using a GitHub repository deploy key

For example one such method to access private repositories is to use a GitHub repository deploy key, the public part of that key is then given to your developers which then store it locally in their SSH agent and then by adding private repository to the `package.json` like this it will be possible to access the private repository:

```json title="package.json"
"dependencies": {
    "GITHUB_REPOSITORY_NAME": "git+ssh://git@github.com:USER_NAME/REPOSITORY_NAME"
}
```

The important part replacing **github** (from the previous examples) with **git+ssh://git@github.com:**, this tells npm to use SSH to get your package (instead of https)

> [!MORE]  
> [GitHub "Managing deploy keys" documentation](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys#deploy-keys)  
> [GitHub "Generating a new SSH key" documentation](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key)  
> [GitHub "Working with SSH key passphrases" documentation](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/working-with-ssh-key-passphrases)  

## publishing a package on npmjs.com

To publish a package on npm you can use the version command to bump the version in your package.json and also create a git commit:

```shell
npm version MY_PACKAGE_VERSION
```

So for example:

```shell
npm version 2.0.0
```

then to actually publish the package you use this command:

```shell
npm publish
```

### publishing a beta version

To publish a beta your version you need to add **-beta.MY_BETA_VERSION** at the end of your version number, MY_BETA_VERSION is a number that **starts at 0 (zero)** when you publish your **first beta**, the next beta will be -beta.1 and so on

The package version (MY_PACKAGE_VERSION) is the version you will want to use when the package comes out of beta, so for example 2.1.0

So to publish the first beta of the 2.1.0 version of your package you use this command:

```shell
npm version 2.1.0-beta.0
```

then to publish the beta you use the option **--tag beta**, like so:

```shell
npm publish --tag beta
```

</article>