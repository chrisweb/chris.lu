%toc%

<article>

# Sentry.io

![banner image of a robot with sentry.io written on his chest that is catching bugs with a huge net](../../../../public/assets/images/app/web_development/posts/sentry-io/banner.png)

Sentry.io is a cloud-based error monitoring service that helps developers by captureing and logging errors (including stack traces and request information) in real-time (when they occur in production). They support via a wide range of languages and frameworks through their ["sentry-*" opensource SDKs](https://github.com/getsentry) that are hosted on GitHub (the error logging SDKs for javascript, React, Capacitor, Next.js and many more have an MIT license, but not all sentry packages do, for example the [self hosted version](https://develop.sentry.dev/self-hosted/) of sentry uses a license called [FSL](https://github.com/getsentry/fsl.software/tree/main) that is NOT an OSI-approved license). Beyond error tracking, Sentry also offers [performance monitoring](https://docs.sentry.io/product/performance) features as well as a feature called [Sessions Replays](https://sentry.io/for/session-replay/) which lets you capture and then replay the user interactions that happend prior to the error occuring, making it easier to reproduce an error and more.

Sentry.io has a (free) [Developer](https://sentry.io/pricing/) plan, for developers that want to start a side project or just experiment with the service, it includes logs for up to 5000 errors, 10k performance metrics and more

> [!MORE]  
> [Sentry.io documentation](https://docs.sentry.io/)  
> [Sentry.io pricing](https://sentry.io/pricing/)  

## Create an account (sign up)

* Go to [sentry.io](https://sentry.io) and then click on **Get Started**
* Next they ask you to create an account, you can do so using your email address or you can connect via your account from a git provider, I chose GitHub (but feel free to click on Google or Azure Devops if you have such an account already, I'm supprised they don't offer you to connect using [GitLab](https://about.gitlab.com/) or [Bitbucket](https://bitbucket.org/) ðŸ˜²) as I intended to connect my GitHub account at some point anyway, as there are some features like converting an error log into a ticket that I want to try out (I usually try to not connect too much accounts which each other as a breach into one of them could potentially give the attacker access to the services that are linked to it too, but in this case I chose to because in the next step we need to connect our GitHub account anyway and allow Sentry.io to create tickets on GitHub for me)
  * for a guide about creating a GitHub account check out my chapter [Create a GitHub account (sign up)](/web_development/posts/github#create-an-account-sign-up) in the GitHub post
* next a pop up window will open, asking you to authorize Sentry.io, there is one request they do which is called [Act on your behalf](https://docs.github.com/en/apps/using-github-apps/authorizing-github-apps#about-github-apps-acting-on-your-behalf), this means that Sentry.io will be able to do tasks on your repositories, this is needed so that Sentry.io can for example help open / update issues in your repositories

![](../../../../public/assets/images/app/web_development/posts/sentry-io/sentry_github_permissions_modal.png)

* click on **Authorize Sentry.io** and you will get redirected to Sentry.io
* on the next page they ask us of we already have a Sentry.io account, if you do follow their instructions in the message, however if like me you don't have an account yet, click on **New Account**
* next we get another form (almost done... yeah yeah ðŸ˜‚), enter a user name for Sentry.io (you can either use your full name, or as I did use your GitHub username, or use any display name you like, if already or later plan to work in a team, then I recommend you chose a name they will recognize)
* then you need to chose an **organization name** and the placeholder of the field says company name, however even do the name is **required** it does NOT mean you can NOT sign up as an individuel, organizations in Sentry.io are like organizations on GitHub, they don't solely represent companies but it can be any group you want, as I have no organisation on GitHub either I just **MY_USER_NAME-projects as name**
* then check the mandatory terms checkbox
* for the email updates chose what ever you prefer
* finally click on **Continue**

Next we have finally arrived on their welcome page,l you can either click on **Start** (which I recommend you do, but more on that in the next chapter) to get a guided tour on how to set up sentry, or set up your team or you can click on the link below to just skip onboarding

> [!MORE]  
> [sentry.io "Get Started" documentation](https://docs.sentry.io/product/sentry-basics/)  
> [GitHub "About GitHub Apps acting on your behalf" documentation](https://docs.github.com/en/apps/using-github-apps/authorizing-github-apps#about-github-apps-acting-on-your-behalf)  

## Create a Sentry.io project

If you just finished the previous chapter and clicked on **Start** then you will have come to a page where you get asked to chose your main framework, else go to your Sentry.io account and on the left click on **Projects** and then **Create project**

Chose whatever framework you like (during onboarding you can only add one at a time, however you will later be able to add more if you like, you could for example add sentry for a PHP Backend API, sentry for React for your frontend code and sentry for iOS and Android for your apps if that's is your technology stack)

Next chose an alert frequency, I kept the default value **Alert me on every new issue** (you can change this later)

Then you can **Name your project and assign it a team**, I again kept the default values

Finally click on **Create Project**

Now click on **Configure SDK**

## Sentry.io SDK for Next.js projects

You can either use the recommended sentry command or follow their manual [setup toturial](https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/), I chose to use the command, if you chose manual you may want to copy the DSN they give you at the end of the page (a Sentry DSN is an API key you will use when setting up your SDK)

> [!TIP]  
> before using the wizard, I recommend commiting your latest changes (if you haven't already) and do a last sync before launching the sentry wizard, this way you will be able to clearly see what stuff Sentry.io will add to your project and you will see what got changed in exsiting files like the next.config.mjs file

In your VSCode terminal (or your preferred command line tool), type the following command:

```shell
npx @sentry/wizard@latest -i nextjs
```

First you will get asked if you accept installing the sentry wizard npm package, press `y` to accept and press `Enter` move on

**Are you using Sentry SaaS or self-hosted Sentry?** you probably want to chose SaaS like me (if you are a company though you might want to have a look at the hosted version) then press `Enter`

**Do you already have an account?** Yes (if you did follow the previous chapter or already had an account before) then press `Enter`

Then the sentry wizard will ask you to login, which will open the sentry login page in your default browser, now login into your account (or create one if you haven't one yet), then go back to your terminal

**Select your Sentry project**, chose the your Sentry Project from the list (when using the wizard Sentry will have automatically created a project for the SDK you chose earlier for you, if however you don't see a Project listed here, you can check out the [Create a Sentry.io project](#create-a-sentryio-project) chapter to create a project first)

Now sentry will install the Sentry SDK for Next.js

**Do you want to route Sentry requests in the browser through your NextJS server to avoid ad blockers?**, Sentry wants to know if it should route the requests it sends out through your Next.js server, by doing so Sentry attempts to bypass the block lists of adblocker addons that are installed in some browsers, this means Sentry will first send the client-side requests to a URL on your server and then your server will forward the request to the Sentry API, I personally chose **Yes** as I want to increase the chance of getting bug reports, but feel free to answer **No** if for example you don't like to have the extra traffic this redirect will cause

**Do you want to create an example page** chose **YES** (we will later use it to test the Sentry setup and then we will delete it)

**Are you using a CI/CD tool to build and deploy your application?** chose **YES** (if you are using Vercel, GitHub actions or any other CI/CD deployment tool, if you are NOT chose **NO**)

Sentry.io Wizard will give you a **SENTRY_AUTH_TOKEN** string, if you use a CI/CD for your deployments, copy the token and save it in a secure location, you will need this token later if for example if you set up a custom GitHub action, then you will want to add that token environement variable to your GitHub secrets and if you use another CI/CD service you should check out their documentation to learn how to use that token to automatically upload sourcemaps to Sentry

CI/CD tools can authenticate themself to Sentry.io using the **SENTRY_AUTH_TOKEN** environment variable and then use the Sentry.io API to automatically upload the sourcemaps of your build to Sentry.io, so that later if there is a bug report on Sentry.io it will be able to use the sourcemaps instead of the minified build files, to show you where the error occured

**Did you configure CI as shown above?** chose **YES**

After answering all questions, the Sentry SDK will edit your next.config.mjs file with sentry specific configuration options and it will have added several sentry.*.config files (to the root of your project) which cotain environment specific configurations

> [!NOTE]  
> if you use Vercel for your deployments, then you don't need to set the **SENTRY_AUTH_TOKEN** yourself, you can use the [Sentry integration for Vercel](https://vercel.com/integrations/sentry), which will set the Vercel environment variables for you  

Next as suggested by the wizard at the end of the installation process, it is recommended to start the development server using the `npm run dev` command and then we visit the Sentry example page in our browser at [http://localhost:3000/sentry-example-page](http://localhost:3000/sentry-example-page)

On that page hit the **Throw Error!** button and then click on the link just below to **visit your Sentry projects issues page**

Now wait for the backend and frontend errors to appear (this can take a few minutes, which is a good time to refresh your cup of coffee â˜• (or what ever beverage you prefer))

As soon as the two errors appear, feel free to click on them and have a look at what error logging on Sentry.io looks like

Before we commit / sync all the changes Sentry.io did in our project, **delete** the `app\sentry-example-page\page.jsx` **test page** and the `app\api\sentry-example-api\route.js` **API test route** files that Sentry.io created to test the error logging, you will not need them anymore

## Sentry.io for Next.js configuration

Sentry.io can be customized a lot and also has several places where you can change the default configuration

Sentry wizard has edited our `next.config.mjs` and it should now look like this:

```mjs title="next.config.mjs"
import { withSentryConfig } from '@sentry/nextjs'

/** @type {import('next').NextConfig} */
const nextConfig = {
    poweredByHeader: false,
};

export default withSentryConfig(nextConfig, {
    // For all available options, see:
    // https://github.com/getsentry/sentry-webpack-plugin#options

    // Suppresses source map uploading logs during build
    silent: true,
    org: "YOUR_ORGANISATION_NAME",
    project: "YOUR_PROJECT_NAME",
}, {
    // For all available options, see:
    // https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/

    // Upload a larger set of source maps for prettier stack traces (increases build time)
    widenClientFileUpload: true,

    // Transpiles SDK to be compatible with IE11 (increases bundle size)
    transpileClientSDK: true,

    // Route browser requests to Sentry through a Next.js rewrite to circumvent ad-blockers.
    // This can increase your server load as well as your hosting bill.
    // Note: Check that the configured route will not match with your Next.js middleware, otherwise reporting of client-
    // side errors will fail.
    tunnelRoute: "/monitoring",

    // Hides source maps from generated client bundles
    hideSourceMaps: true,

    // Automatically tree-shake Sentry logger statements to reduce bundle size
    disableLogger: true,

    // Enables automatic instrumentation of Vercel Cron Monitors.
    // See the following for more information:
    // https://docs.sentry.io/product/crons/
    // https://vercel.com/docs/cron-jobs
    automaticVercelMonitors: true,
})
```

> [!NOTE]  
> By default the options that the wizard set for us are good enough, as soon as you have the time I recommend checking out the [Extend your Next.js Configuration](https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/#extend-your-nextjs-configuration) Sentry.io documentation which explains what each option does

Another file that got added to the root of our project is `sentry.client.config.ts`, the file is being used to configuration Sentry.io for **client components**, check out the [Next.js SDK Configuration Options](https://docs.sentry.io/platforms/javascript/guides/nextjs/configuration/options/) documentation for more details about each option, I slighly modified my configuration file to be like this:

```ts title="sentry.client.config.ts" showLineNumbers {3-12} {18} {23} {27} {38}
import * as Sentry from '@sentry/nextjs'

let replaysOnErrorSampleRate = 0
let tracesSampleRate = 0.1

if (process.env.NODE_ENV === 'production') {
    replaysOnErrorSampleRate = 1
}

if (process.env.NODE_ENV === 'development') {
    tracesSampleRate = 0
}

Sentry.init({
    dsn: 'https://daf0befe66519725bbe2ad707a11bbb3@o4504017992482816.ingest.sentry.io/4506763918770176',

    // Adjust this value in production, or use tracesSampler for greater control
    tracesSampleRate: tracesSampleRate,

    // Setting this option to true will print useful information to the console while you're setting up Sentry.
    debug: false,

    replaysOnErrorSampleRate: replaysOnErrorSampleRate,

    // This sets the sample rate to be 10%. You may want this to be 100% while
    // in development and sample at a lower rate in production
    replaysSessionSampleRate: 0,

    // You can remove this option if you're not planning to use the Sentry Session Replay feature:
    integrations: [
        Sentry.replayIntegration({
            // Additional Replay configuration goes in here, for example:
            maskAllText: true,
            blockAllMedia: true,
        }),
    ],

    environment: process.env.NODE_ENV ? process.env.NODE_ENV : '',
})
```

line 3-12 I added two variables for the **replaysOnErrorSampleRate** and the **tracesSampleRate**, replaysOnErrorSampleRate I set to zero by default to not produce replays when not in production, then line 6-8 I added a check to verify if the current environment is **production** and if it is I tell Sentry to always make a replay if there is an error (be careful with this option, in the free plan you only have 50 replays per month, which is why I only turn it on in production, also in development it is usually the developer themself that triggers the error so there is not really a need for a replay), the tracesSampleRate I set it to 0.1, meaning 10% of the traces will get sent to Sentry but then line 10-12 I disable them in development (this is to ensure no performance metrics are getting calculated when the app is running on a local computer, to check local performance it is preferred to use the developer tools), you may want a lower or higher value depending on what plan you are on and then check if you reach your limits or not and then adjust over time

Line 27 I completly disabled **replaysSessionSampleRate**, meaning there will be no replays being made when there is no error, the free plan has 50 replays per month and I prefer to keep all the replays for cases where there is a bug

Line 38 I pass the environment to Sentry, meaning Sentry will know if the environment is preview or production (that value is based on the Vercel environment on which Next.js got deployed)

`sentry.edge.config.ts` are the options for when Next.js uses the [Vercel Edge Network](https://vercel.com/docs/edge-network/overview), I kept that file as, but feel free to adjust any values to fit your use case

`sentry.server.config.ts` is again similar to the previous two, just this one is specifically for Next.js server side options, I also kept this file as is

> [!MORE]  
> [Sentry.io "Extend your Next.js Configuration" documentation](https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/#extend-your-nextjs-configuration)  
> [Sentry.io "Next.js SDK Configuration" documentation](https://docs.sentry.io/platforms/javascript/guides/nextjs/configuration/options/)  

## Investigating Sentry.io dropped requests

When trying to log my CSP reports in Sentry.io I could see that some reports got dropped but the stats page did not give me the exact reason

To get the exact reason why a request got dropped you can use the Sentry.io API

To get some data about the events, you can use Curl to make the following request:

```shell
curl https://sentry.io/api/0/organizations/{organization_slug}/stats-summary/ \
 -H 'Authorization: Bearer <auth_token>'
```

You will however need an auth token, which you can get creating a custom **integration** for your organization, like so:
 
* to get an auth token go to "Settings", then in the section "Developer Settings" click on "Custom Integrations"
* then click on "Create New Integration", chose "Create Internal Integration" and click on "Next"
* then add a project name and then under "Permissions" for "Issue & Event" chose "Read" then click on "Save Changes"
* then on the Integration page, scroll down and click on "New Token", copy the token (you will need it later to do API requests) and then click on "Done"
* finally click on save changes

No that you have your auth token you can make an API call like this (replace MY_ORGANIZATION with the name of your organiyation on Sentry.io and replace xxx111 at the end with your actual auth token):

```shell
curl 'https://sentry.io/api/0/organizations/MY_ORGANIZATION/stats-summary/?field=sum(times_seen)&statsPeriod=24h' -H 'Authorization: Bearer xxx111'
```

On Mac / Linux use the **terminal** or your favorite command line tool to execute the command, on Windows I recommend using **Git Bash**

This will hopefully help you understand if your requests got filtered, were invalid or if there was another reason why they got dropped

> [!MORE]  
> [Sentry.io "Sentry API organization events" documentation](https://docs.sentry.io/api/organizations/retrieve-event-counts-for-an-organization-v2/)

## Disable the "reports from locahost" filter

If you want to disable (or re-enable) the Sentry.io reports from localhost filter, do this:

* visit Sentry.io and log in
* in the left navigation on the bottom click on **Settings**
* Then in the Settings navigation on the left click on **Projects**
* Click on the project name
* Then in navigation on the left, under **PROCESSING**, click on **Inbound Filters**
* On that page there is an option called **Filter out events coming from localhost** disable that option to not filter reports coming from localhost anymore

</article>
